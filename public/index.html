<!DOCTYPE html>
<html>
    <head>
        <title>MultiPlayer Games</title>
        <style>
            html, body {
                padding: 0;
                margin: 0;
                height: 100%;
            }
            .flexcol {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: space-around;
                gap: .5em;
            }
            .flexrow {
                display: flex;
                flex-direction: row;
                align-items: center;
                justify-content: space-around;
                gap: .5em;
            }
            .fill {
                flex: 1;
            }
            #aspect_ratio_wrapper {
                outline: 1px solid lightgrey;
                width: 500px;
                height: 500px;
            }
            #joypads {
                width: 90%;
            }
            #joypads iframe {
                width: 100%;
                aspect-ratio: 16 / 9;
            }
            #disconnected {
                width: 100%;
            }
            #disconnected_img {
                width: 50%;
                max-width: 400px;
            }
        </style>
        <script src="two.min.js"></script>
        <script type="module" src="games-menu.mjs"></script>
    </head>
    <body class="flexcol">
        <div id="fullscreen_wrapper" class="flexcol">
            <div id="aspect_ratio_wrapper" class="flexcol"></div>
        </div>
        <div id="joypads" class="flexcol" style="display: none"></div>
        <div id="menu" class="flexcol"></div>
        <div id="disconnected" class="flexcol fill" style="display: none; justify-content: center; ">
            <img id="disconnected_img" src="/assets/disconnected.png">
            <div>You have been <b>disconnected</b> !</div>
        </div>
    </body>
    <script type="module">

        import Consts from './consts.mjs'

        const urlParams = new URLSearchParams(window.location.search)
        const nbEmbeddedJoypads  = parseInt(urlParams.get('joypad') || '0')

        let gameWs = null
        let game = null
        let players = null

        const wrapperEl = document.getElementById("aspect_ratio_wrapper")
        const joypadsEl = document.getElementById("joypads")
        const menuEl = document.getElementById("menu")
        const disconnectedEl = document.getElementById("disconnected")

        function initGameWebsocket() {
            const socketProtocol = (window.location.protocol.includes('https')) ? 'wss' : 'ws'
            gameWs  = new WebSocket(`${socketProtocol}://${window.location.host}`)

            gameWs.addEventListener('open', () => {
                console.log('Connected to server')
                gameWs.send(Consts.MSG_KEYS.IDENTIFY_GAME)
            })

            gameWs.addEventListener('message', evt => {
                const key = evt.data.substring(0, Consts.MSG_KEY_LENGTH)
                const data = evt.data.substring(Consts.MSG_KEY_LENGTH)
                if(key === Consts.MSG_KEYS.IDENTIFY_GAME) handleGameIdentification(JSON.parse(data))
                else if(key === Consts.MSG_KEYS.SYNC_PLAYERS) handleSyncPlayers(JSON.parse(data))
                else if(key === Consts.MSG_KEYS.JOYPAD_INPUT) handleJoypadInput(data)
                else console.warn("Unknown websocket key", key)
            })

            gameWs.addEventListener('close', handleCloseConnection)

            gameWs.addEventListener('error', console.error)

            gameWs.sendInput = data => {
                gameWs.send(Consts.MSG_KEYS.GAME_INPUT + JSON.stringify(data))
            }
        }

        function handleGameIdentification(kwargs) {
            gameWs.roomId = kwargs.roomId
            console.log(`Identified as game for room '${gameWs.roomId}'`)
            gameWs.joypadUrl = new URL(`room/${gameWs.roomId}`, window.location.href)
            console.log(`Joypad URL: ${gameWs.joypadUrl }`)
            for(let i=0; i<nbEmbeddedJoypads; ++i) addEmbeddedJoypad(gameWs.joypadUrl)
        }

        function handleSyncPlayers(kwargs) {
            players = kwargs
            if(game) game.syncPlayers(players)
        }

        function handleJoypadInput(data) {
            const idx = data.indexOf(':')
            const playerId = data.substring(0, idx)
            const kwargs = JSON.parse(data.substring(idx+1))
            if(game) game.handleJoypadInput(playerId, kwargs)
        }

        function handleCloseConnection() {
            for(const el of [wrapperEl, joypadsEl, menuEl]) el.style.display = "none"
            disconnectedEl.style.display = ""
        }

        function addEmbeddedJoypad(joypadUrl) {
            const iframeEl = document.createElement("iframe")
            iframeEl.src = `${joypadUrl}?fs=0`
            joypadsEl.appendChild(iframeEl)
            joypadsEl.style.display = ""
        }

        function initGamesMenu() {
            const gamesMenuEl = document.createElement("games-menu")
            gamesMenuEl.onSelect = gameKey => startGame(gameKey)
            menuEl.innerHTML = ""
            menuEl.appendChild(gamesMenuEl)
        }

        async function startGame(gameKey) {
            const src = await import(`/game/${gameKey}/game.mjs`)
            wrapperEl.innerHTML = ""
            game = src.startGame(wrapperEl, gameWs)
            if(players) game.syncPlayers(players)
            gameWs.send(Consts.MSG_KEYS.START_GAME + JSON.stringify({
                gameKey,
            }))
        }

        function addFullscreenEventListerner() {
            wrapperEl.addEventListener("click", evt => {
                if(!document.fullscreenElement) {
                    wrapperEl.parentElement.requestFullscreen()
                    evt.preventDefault()
                }
            })
        }

        addFullscreenEventListerner()
        initGameWebsocket()
        initGamesMenu()
    </script>
</html>