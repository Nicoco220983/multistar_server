<html>
    <head>
        <title>MultiPlayer Joypad</title>
        <style>
            body {
                padding: 0;
                margin: 0;
                height: 100%;
            }
            .flexcol {
                display: flex;
                flex-direction: column;
                gap: 5px;
            }
            .flexrow {
                display: flex;
                flex-direction: row;
                gap: 5px;
            }
            .center {
                align-items: center;
                justify-content: center;
            }
            #aspect_ratio_wrapper {
                outline: 1px solid lightgrey;
                width: 500px;
                height: 500px;
            }
        </style>
        <script src="../two.min.js"></script>
        <script type="module" src="/color-picker.mjs"></script>
    </head>
    <body class="flexcol center">
        <div id="identification" class="flexcol">
            <p class="flexrow center">
                Enter your name: <input class="player_name" type="text">
            </p>
            <p class="flexrow center">
                Pick your color: <color-picker id="color_picker"></color-picker>
            </p>
            <p class="flexrow center"><button class="join">Join</button></p>
        </div>
        <div id="fullscreen_wrapper" class="center">
            <div id="aspect_ratio_wrapper" class="center"></div>
        </div>
        <div id="games_menu" class="center"></div>
    </body>
    <script type="module">

        import Consts from '../consts.mjs'

        const colors = ["red","blue","yellow","green","purple","orange"]

        const idEl = document.getElementById("identification")
        const colorPickerEl = document.getElementById("color_picker")
        const wrapperEl = document.getElementById("aspect_ratio_wrapper")
        const gamesMenuEl = document.getElementById("games_menu")

        const roomId = window.location.pathname.split("/").pop()
        const urlParams = new URLSearchParams(window.location.search)
        const fullscreenActivated  = urlParams.get('fs') !== '0'

        let step = "IDENTIFICATION"
        let joypadWs = null
        let gameKey = null
        let player = null
        let players = null

        function initJoypadWebsocket() {
            const socketProtocol = (window.location.protocol.includes('https')) ? 'wss' : 'ws'
            joypadWs  = new WebSocket(`${socketProtocol}://${window.location.host}`)

            joypadWs.addEventListener('open', () => {
                console.log('Connected to server')
                joypadWs.send(Consts.MSG_KEYS.IDENTIFY_PLAYER + JSON.stringify({
                    roomId,
                }))
            })

            joypadWs.addEventListener('message', evt => {
                const key = evt.data.substring(0, Consts.MSG_KEY_LENGTH)
                const data = evt.data.substring(Consts.MSG_KEY_LENGTH)
                if(key === Consts.MSG_KEYS.IDENTIFY_PLAYER) handleIdentifyPlayer(JSON.parse(data))
                else if(key === Consts.MSG_KEYS.START_GAME) handleStartGame(JSON.parse(data))
                else if(key === Consts.MSG_KEYS.SYNC_PLAYERS) handleSyncPlayers(JSON.parse(data))
                else console.warn("Unknown websocket key", key)
            })

            joypadWs.addEventListener('close', () => handleCloseConnection())

            joypadWs.addEventListener('error', console.error)
        }

        function initIdentificationForm() {
            idEl.style.display = ""
            wrapperEl.style.display = "none"
            gamesMenuEl.style.display = "none"

            colorPickerEl.onSelect = color => {
                player.color = color
                joypadWs.send(Consts.MSG_KEYS.IDENTIFY_PLAYER + JSON.stringify(player))
            }

            idEl.querySelector(".join").onclick = () => {
                player.name = idEl.querySelector(".player_name").value || player.name || "Player"
                joypadWs.send(Consts.MSG_KEYS.IDENTIFY_PLAYER + JSON.stringify(player))
                initGame()
            }
        }

        function initGame() {
            step = "GAME"
            idEl.style.display = "none"
            wrapperEl.style.display = ""
            gamesMenuEl.style.display = ""
            if(gameKey) startJoypad(gameKey)
        }

        function handleIdentifyPlayer(kwargs) {
            player = kwargs
            idEl.querySelector(".player_name").placeholder = player.name
            colorPickerEl.syncColor(player.color)
        }

        function handleStartGame(kwargs) {
            gameKey = kwargs.gameKey
            console.log(`Game set to '${gameKey}'`)
            if(step === "GAME") startJoypad(gameKey)
        }

        function handleSyncPlayers(kwargs) {
            players = kwargs
        }

        function handleCloseConnection() {
            wrapperEl.innerHTML = "<p>Deconnected from server :(</p>"
        }

        async function startJoypad(gameKey) {
            const joypad = await import(`/game/${gameKey}/joypad.mjs`)
            wrapperEl.innerHTML = ""
            const sendInput = data => {
                joypadWs.send(Consts.MSG_KEYS.JOYPAD_INPUT + JSON.stringify(data))
            }
            joypad.startJoypad(
                wrapperEl,
                player,
                sendInput,
            )
        }

        function addFullscreenEventListener() {
            wrapperEl.addEventListener("click", evt => {
                if(!document.fullscreenElement) {
                    wrapperEl.parentElement.requestFullscreen()
                    evt.preventDefault()
                }
            })
        }

        if(fullscreenActivated) addFullscreenEventListener()
        initJoypadWebsocket()
        initIdentificationForm()
    </script>
</html>